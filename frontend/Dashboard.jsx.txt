"import { useState, useEffect, useCallback } from \"react\";
import { toast } from \"sonner\";
import Sidebar from \"@/components/Sidebar\";
import FireMap from \"@/components/FireMap\";
import { API } from \"@/App\";

export default function Dashboard() {
  const [fires, setFires] = useState([]);
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [filters, setFilters] = useState({
    minConfidence: 0,
    hours: 24,
    showHeatmap: false,
  });
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [selectedFire, setSelectedFire] = useState(null);
  const [searchLocation, setSearchLocation] = useState(null);

  // Fetch fires from API
  const fetchFires = useCallback(async () => {
    try {
      const params = new URLSearchParams({
        hours: filters.hours,
        min_confidence: filters.minConfidence,
        limit: 5000,
      });
      
      const response = await fetch(`${API}/fires/recent?${params}`);
      if (!response.ok) throw new Error(\"Failed to fetch fires\");
      
      const data = await response.json();
      setFires(data);
    } catch (error) {
      console.error(\"Error fetching fires:\", error);
      toast.error(\"Failed to load fire data\");
    }
  }, [filters.hours, filters.minConfidence]);

  // Fetch stats
  const fetchStats = useCallback(async () => {
    try {
      const response = await fetch(`${API}/fires/stats`);
      if (!response.ok) throw new Error(\"Failed to fetch stats\");
      
      const data = await response.json();
      setStats(data);
    } catch (error) {
      console.error(\"Error fetching stats:\", error);
    }
  }, []);

  // Initial data load
  useEffect(() => {
    const loadData = async () => {
      setLoading(true);
      await Promise.all([fetchFires(), fetchStats()]);
      setLoading(false);
    };
    loadData();
  }, [fetchFires, fetchStats]);

  // Auto-refresh every 30 seconds
  useEffect(() => {
    const interval = setInterval(() => {
      fetchFires();
      fetchStats();
    }, 30000);
    
    return () => clearInterval(interval);
  }, [fetchFires, fetchStats]);

  // Trigger NASA data fetch
  const handleFetchNASAData = async () => {
    try {
      toast.info(\"Fetching latest NASA FIRMS data...\");
      const response = await fetch(`${API}/fires/fetch?days=1`, {
        method: \"POST\",
      });
      
      if (!response.ok) throw new Error(\"Failed to trigger fetch\");
      
      toast.success(\"NASA data fetch initiated!\");
      
      // Refresh data after a delay
      setTimeout(() => {
        fetchFires();
        fetchStats();
      }, 5000);
    } catch (error) {
      console.error(\"Error triggering fetch:\", error);
      toast.error(\"Failed to fetch NASA data\");
    }
  };

  // Handle location search
  const handleSearch = async (query) => {
    if (!query.trim()) return;
    
    try {
      // Use OpenStreetMap Nominatim for geocoding
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`
      );
      const results = await response.json();
      
      if (results.length > 0) {
        const { lat, lon, display_name } = results[0];
        setSearchLocation({
          lat: parseFloat(lat),
          lng: parseFloat(lon),
          name: display_name,
        });
        toast.success(`Found: ${display_name.split(\",\")[0]}`);
      } else {
        toast.error(\"Location not found\");
      }
    } catch (error) {
      console.error(\"Search error:\", error);
      toast.error(\"Search failed\");
    }
  };

  if (loading) {
    return (
      <div className=\"loading-overlay\" data-testid=\"loading-overlay\">
        <div className=\"loading-spinner\"></div>
        <p className=\"mt-4 text-slate-400 font-mono text-sm tracking-wider\">
          INITIALIZING PYROWATCH...
        </p>
      </div>
    );
  }

  return (
    <div className=\"relative w-full h-screen overflow-hidden\" data-testid=\"dashboard\">
      <Sidebar
        collapsed={sidebarCollapsed}
        onToggle={() => setSidebarCollapsed(!sidebarCollapsed)}
        stats={stats}
        filters={filters}
        onFiltersChange={setFilters}
        onSearch={handleSearch}
        onFetchData={handleFetchNASAData}
        fireCount={fires.length}
      />
      
      <div 
        className={`map-wrapper ${sidebarCollapsed ? 'map-wrapper-full' : ''}`}
        data-testid=\"map-wrapper\"
      >
        <FireMap
          fires={fires}
          showHeatmap={filters.showHeatmap}
          selectedFire={selectedFire}
          onSelectFire={setSelectedFire}
          searchLocation={searchLocation}
          onClearSearch={() => setSearchLocation(null)}
        />
      </div>
    </div>
  );
}
"